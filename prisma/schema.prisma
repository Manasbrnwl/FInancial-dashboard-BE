generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["market_data", "periodic_market_data"]
}

model bse_equity {
  id         Int       @id @default(autoincrement())
  symbol_id  String?
  symbol     String    @db.VarChar(50)
  date       DateTime  @db.Date
  open       Float?
  high       Float?
  low        Float?
  close      Float?
  volume     String?
  oi         String?
  exchange   String?   @db.VarChar(10)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt @db.Timestamp(6)

  @@unique([symbol, date], map: "bse_equity_symbol_date_unique")
  @@index([symbol, date], map: "idx_bse_eq_symbol_date")
  @@schema("market_data")
}

model nse_equity {
  id         BigInt    @id @default(autoincrement())
  symbol_id  String?
  symbol     String    @db.VarChar(50)
  date       DateTime  @db.Date
  open       Float?
  high       Float?
  low        Float?
  close      Float?
  volume     String?
  oi         String?
  exchange   String?   @db.VarChar(10)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt @db.Timestamp(6)

  @@unique([symbol, date], map: "nse_equity_symbol_date_unique")
  @@index([symbol, date], map: "idx_nse_eq_symbol_date")
  @@schema("market_data")
}

model nse_futures {
  id          BigInt    @id @default(autoincrement())
  symbol_id   String?
  symbol      Int
  date        DateTime  @db.Date
  open        Float?
  high        Float?
  low         Float?
  close       Float?
  volume      String?
  oi          String?
  underlying  Int?
  expiry_date DateTime? @db.Date
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  updated_at  DateTime? @updatedAt @db.Timestamp(6)

  @@unique([symbol, date, underlying, expiry_date], map: "nse_futures_symbol_date_underlying_expir_unique")
  @@index([symbol, date], map: "idx_nse_fut_symbol_date")
  @@schema("market_data")
}

model nse_options {
  id           BigInt    @id @default(autoincrement())
  symbol_id    String?
  symbol       Int
  date         DateTime  @db.Date
  open         Float?
  high         Float?
  low          Float?
  close        Float?
  volume       String?
  oi           String?
  underlying   Int?
  expiry_date  DateTime? @db.Date
  strike       String?
  option_type  String?   @db.VarChar(2)
  created_at   DateTime? @default(now()) @db.Timestamp(6)
  updated_at   DateTime? @updatedAt @db.Timestamp(6)
  expiry_month String?

  @@unique([symbol, date, underlying, expiry_date, option_type], map: "nse_options_symbol_date_underlying_expiry_unique")
  @@index([strike, date], map: "idx_nse_opt_strike_date")
  @@index([symbol, date], map: "idx_nse_opt_symbol_date")
  @@index([expiry_date], map: "idx_nse_options_expiry_date")
  @@index([expiry_month], map: "idx_options_expirymonth")
  @@schema("market_data")
}

model instrument_lists {
  id              Int                  @id @default(autoincrement())
  exchange        String               @db.VarChar(100)
  instrument_type String               @db.VarChar(100)
  created_at      DateTime?            @default(now()) @db.Timestamp(6)
  updated_at      DateTime?            @updatedAt @db.Timestamp(6)
  intrumentExpiry instruments_expiry[]

  @@unique([exchange, instrument_type], map: "instrument_lists_exchange_instrument_type_unique")
  @@index([exchange, instrument_type], map: "idx_instrument_lists_exchange_instrument_type")
  @@index([id, instrument_type], map: "idx_instrument_lists_id")
  @@index([id, instrument_type], map: "idx_instrument_lists_id_type")
  @@schema("market_data")
}

model instruments_expiry {
  id             Int               @id @default(autoincrement())
  instrument_id  Int?
  expiry_date    DateTime?         @db.Date
  created_at     DateTime?         @default(now()) @db.Timestamp(6)
  updated_at     DateTime?         @updatedAt @db.Timestamp(6)
  segment        String?           @db.VarChar(5)
  instrumentList instrument_lists? @relation(fields: [instrument_id], references: [id])

  @@unique([instrument_id, expiry_date, segment], map: "instruments_expiry_instrument_id_expiry_date_unique")
  @@index([instrument_id, expiry_date], map: "idx_instruments_expiry_instrument_id_expiry_date")
  @@schema("market_data")
}

model bhavcopy_uploaded {
  id         Int       @id @default(autoincrement())
  date       DateTime  @db.Date
  count      Int
  segment    String?   @db.VarChar(100)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt @db.Timestamp(6)

  @@unique([date, count, segment], map: "bhavcopy_date_count_segment_unique")
  @@index([date, count, segment], map: "idx_bhavcopy_date_count_segment")
  @@schema("market_data")
}

model dates_missed {
  id         Int       @id @default(autoincrement())
  date       DateTime  @db.Date
  day        String?   @db.VarChar(100)
  segment    String?   @db.VarChar(100)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt @db.Timestamp(6)

  @@unique([date, segment], map: "dates_missed_date_segment_unique")
  @@index([date, segment], map: "idx_dates_missed_date_segment")
  @@schema("market_data")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model symbols_list {
  id            Int       @id @default(autoincrement())
  instrument_id Int
  symbol        String    @db.VarChar(100)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  updated_at    DateTime? @updatedAt @db.Timestamp(6)
  segment       String?   @db.VarChar(5)
  expiry_date   DateTime? @db.Date
  strike        String?   @default(dbgenerated("0")) @db.VarChar(15)
  option_type   String?   @db.VarChar(2)
  expiry_month  String?

  @@unique([instrument_id, symbol], map: "instrument_symbol_unique")
  @@index([instrument_id, symbol], map: "idx_instrument_symbol")
  @@index([instrument_id], map: "idx_symbols_list_instrument_id")
  @@index([segment], map: "idx_symbols_list_segment")
  @@index([instrument_id, expiry_date(sort: Desc)], map: "idx_symbols_expiry")
  @@index([expiry_month], map: "idx_symbols_expirymonth")
  @@index([option_type, expiry_date, instrument_id], map: "idx_symbols_opt_exp")
  @@schema("market_data")
}

model ohlcDataNSE {
  id           BigInt   @id @default(autoincrement())
  instrumentId Int
  open         String
  high         String
  low          String
  close        String
  volume       String?  @default("0")
  oi           String?  @default("0")
  time         DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([instrumentId, time], map: "uniq_data_nse")
  @@index([instrumentId], map: "idx_instrumentId_nse")
  @@index([time], map: "idx_time_nse")
  @@schema("periodic_market_data")
}

model ohlcEQDataBSE {
  id           BigInt   @id @default(autoincrement())
  instrumentId BigInt
  open         String
  high         String
  low          String
  close        String
  volume       String?  @default("0")
  oi           String?  @default("0")
  time         DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([instrumentId, time], map: "uniq_data_bse")
  @@index([instrumentId], map: "idx_instrumentId_bse")
  @@index([time], map: "idx_time_bse")
  @@schema("periodic_market_data")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model ticksDataNSEEQ {
  id           BigInt    @id @default(autoincrement())
  instrumentId Int
  ltp          String
  volume       String?   @default("0")
  oi           String?   @default("0")
  bid          String?   @default("0")
  bidqty       String?   @default("0")
  ask          String?   @default("0")
  askqty       String?   @default("0")
  time         DateTime
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  time_bucket  DateTime? @db.Timestamp(6)

  @@unique([instrumentId, time], map: "uniq_data_nse_eq")
  @@index([instrumentId], map: "idx_instrumentId_nse_eq")
  @@index([time], map: "idx_time_nse_eq")
  @@index([instrumentId], map: "idx_ticksdatanseeq_instrumentid")
  @@index([instrumentId, id(sort: Desc), ltp], map: "idx_cover_ticks_nseeq")
  @@index([instrumentId, id(sort: Desc)], map: "idx_ticks_nseeq_instrument_id_desc")
  @@index([instrumentId, time(sort: Desc)], map: "idx_eq_time")
  @@index([instrumentId, time_bucket, time(sort: Desc)], map: "idx_eq_inst_tb")
  @@schema("periodic_market_data")
}

model ticksDataNSEFUT {
  id           BigInt   @id @default(autoincrement())
  instrumentId Int
  ltp          String
  volume       String?  @default("0")
  oi           String?  @default("0")
  bid          String?  @default("0")
  bidqty       String?  @default("0")
  ask          String?  @default("0")
  askqty       String?  @default("0")
  time         DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@unique([instrumentId, time], map: "uniq_data_nse_fut")
  @@index([instrumentId], map: "idx_instrumentId_nse_fut")
  @@index([time], map: "idx_time_nse_fut")
  @@schema("periodic_market_data")
}

model ticksDataNSEOPT {
  id           BigInt   @id @default(autoincrement())
  instrumentId Int
  ltp          String
  volume       String?  @default("0")
  oi           String?  @default("0")
  bid          String?  @default("0")
  bidqty       String?  @default("0")
  ask          String?  @default("0")
  askqty       String?  @default("0")
  time         DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@unique([instrumentId, time], map: "uniq_data_nse_opt")
  @@index([instrumentId], map: "idx_instrumentId_nse_opt")
  @@index([time], map: "idx_time_nse_opt")
  @@index([instrumentId], map: "idx_ticksdatanseopt_instrumentid")
  @@index([instrumentId, id(sort: Desc), ltp, volume], map: "idx_cover_ticks_nseopt")
  @@index([instrumentId, id(sort: Desc)], map: "idx_ticks_nseopt_instrument_id_desc")
  @@index([instrumentId, id(sort: Desc)], map: "idx_opt_latest")
  @@index([instrumentId, id(sort: Desc)], map: "idx_opt_instrumentid_id_desc")
  @@schema("periodic_market_data")
}

model gap_time_series {
  id            BigInt   @id @default(autoincrement())
  instrument_id Int
  date          DateTime @db.Date
  time_slot     String   @db.VarChar(5)
  gap_1         Float
  gap_2         Float
  price_1       Float?
  price_2       Float?
  price_3       Float?
  created_at    DateTime @default(now()) @db.Timestamp(6)

  @@unique([instrument_id, date, time_slot], map: "gap_time_series_instrument_date_slot_unique")
  @@index([instrument_id, time_slot, date(sort: Desc)], map: "idx_gap_time_series_instrument_slot_date")
  @@schema("market_data")
}

model gap_alerts {
  id                BigInt   @id @default(autoincrement())
  instrument_id     Int
  instrument_name   String
  time_slot         String   @db.VarChar(5)
  alert_type        String   @db.VarChar(10)
  current_value     Float
  avg_value         Float
  deviation_percent Float
  triggered_at      DateTime @default(now()) @db.Timestamp(6)

  @@index([instrument_id, triggered_at], map: "idx_gap_alerts_instrument_triggered")
  @@index([triggered_at], map: "idx_gap_alerts_triggered")
  @@schema("market_data")
}

model gap_alert_config {
  id                Int      @id @default(autoincrement())
  instrument_id     Int?     @unique(map: "gap_alert_config_instrument_unique")
  percent_threshold Float    @default(15)
  comparison_days   Int      @default(15)
  cooldown_minutes  Int      @default(30)
  baseline_days_min Int      @default(10)
  baseline_days_max Int      @default(20)
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now()) @db.Timestamp(6)
  updated_at        DateTime @updatedAt @db.Timestamp(6)

  @@schema("market_data")
}
